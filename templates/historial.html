<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Análisis - Analizador de YouTube</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header Principal -->
    <header class="header">
        <div class="header__container">
            <div class="header__brand">
                <svg class="header__logo" width="32" height="32" viewBox="0 0 24 24" fill="none">
                    <path d="M23 7l-7 5 7 5V7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                </svg>
                <h1 class="header__title">Historial de Análisis</h1>
            </div>
            <nav class="header__nav" id="mobile-nav">
                <a href="/" class="btn btn--primary btn--gradient">
                    <svg class="btn__icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Nuevo Análisis
                </a>
                <a href="{{ url_for('add_channel') }}" class="btn btn--secondary">
                    <svg class="btn__icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Añadir Canal
                </a>
            </nav>
            <button class="header__menu-toggle" id="menu-toggle" aria-label="Abrir menú" aria-expanded="false">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>

    <!-- Contenedor Principal -->
    <main class="main-container">
        <!-- Hero Section con Estadísticas -->
        <section class="hero hero--compact">
            <div class="hero__content">
                <h2 class="hero__title">Tu Historial Completo</h2>
                <p class="hero__description">
                    Revisa todos los análisis realizados, descarga los resultados y monitorea el progreso de los análisis en curso.
                </p>
            </div>
            <div class="hero__stats">
                <div class="stat-card">
                    <span class="stat-card__value">{{ jobs|length }}</span>
                    <span class="stat-card__label">Total análisis</span>
                </div>
                <div class="stat-card">
                    <span class="stat-card__value">{{ jobs|selectattr('2', 'equalto', 'completed')|list|length }}</span>
                    <span class="stat-card__label">Completados</span>
                </div>
                <div class="stat-card">
                    <span class="stat-card__value">{{ jobs|selectattr('2', 'equalto', 'pending')|list|length }}</span>
                    <span class="stat-card__label">En proceso</span>
                </div>
            </div>
        </section>

        <!-- Filtros (opcional, para futura implementación) -->
        <section class="filters-section">
            <div class="filters-section__container">
                <button class="filter-chip filter-chip--active">
                    Todos
                    <span class="filter-chip__count">{{ jobs|length }}</span>
                </button>
                <button class="filter-chip">
                    <svg class="filter-chip__icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Completados
                    <span class="filter-chip__count">{{ jobs|selectattr('2', 'equalto', 'completed')|list|length }}</span>
                </button>
                <button class="filter-chip">
                    <svg class="filter-chip__icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    En proceso
                    <span class="filter-chip__count">{{ jobs|selectattr('2', 'equalto', 'pending')|list|length }}</span>
                </button>
                <button class="filter-chip">
                    <svg class="filter-chip__icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Con errores
                    <span class="filter-chip__count">{{ jobs|selectattr('2', 'equalto', 'failed')|list|length }}</span>
                </button>
            </div>
        </section>

        <!-- Tabla/Lista de Análisis -->
        <section class="history-section">
            {% if jobs %}
                <!-- Vista Desktop: Tabla -->
                <div class="table-container">
                    <table class="table table--modern">
                        <thead>
                            <tr>
                                <th>
                                    <div class="th-content">
                                        <svg class="th-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                                            <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke="currentColor" stroke-width="2"/>
                                        </svg>
                                        Fecha
                                    </div>
                                </th>
                                <th>
                                    <div class="th-content">
                                        <svg class="th-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                                            <path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" stroke="currentColor" stroke-width="2"/>
                                        </svg>
                                        Canal Analizado
                                    </div>
                                </th>
                                <th>
                                    <div class="th-content">
                                        <svg class="th-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2"/>
                                        </svg>
                                        Estado
                                    </div>
                                </th>
                                <th style="width: 280px;">
                                    <div class="th-content">
                                        <svg class="th-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                                            <path d="M13 10V3L4 14h7v7l9-11h-7z" stroke="currentColor" stroke-width="2"/>
                                        </svg>
                                        Acciones
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for job in jobs %}
                            <tr class="table-row">
                                <td>
                                    <div class="date-cell">
                                        <span class="date-cell__date">{{ job[3].split(' ')[0] }}</span>
                                        <span class="date-cell__time">{{ job[3].split(' ')[1] if ' ' in job[3] else '' }}</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="channel-cell">
                                        <div class="channel-cell__avatar">
                                            {{ (job[1] or 'N')[0]|upper }}
                                        </div>
                                        <span class="channel-cell__name">{{ job[1] or 'N/A' }}</span>
                                    </div>
                                </td>
                                <td>
                                    {% if job[2] == 'completed' %}
                                        <span class="status-badge status-badge--success">
                                            <svg class="status-badge__icon" width="14" height="14" viewBox="0 0 24 24" fill="none">
                                                <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                                            </svg>
                                            Completado
                                        </span>
                                    {% elif job[2] == 'pending' %}
                                        <span class="status-badge status-badge--pending">
                                            <svg class="status-badge__icon status-badge__icon--spinning" width="14" height="14" viewBox="0 0 24 24" fill="none">
                                                <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                            </svg>
                                            En proceso
                                        </span>
                                    {% else %}
                                        <span class="status-badge status-badge--error">
                                            <svg class="status-badge__icon" width="14" height="14" viewBox="0 0 24 24" fill="none">
                                                <path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                            </svg>
                                            Error
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="actions-cell">
                                        <a href="{{ url_for('show_result', job_id=job[0]) }}" 
                                           class="btn btn--small {% if job[2] == 'pending' %}btn--secondary{% else %}btn--primary{% endif %}">
                                            <svg class="btn__icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke="currentColor" stroke-width="2"/>
                                                <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke="currentColor" stroke-width="2"/>
                                            </svg>
                                            {% if job[2] == 'pending' %}Ver Progreso{% else %}Ver Resultado{% endif %}
                                        </a>
                                        {% if job[2] == 'completed' %}
                                        <a href="{{ url_for('download_json', job_id=job[0]) }}" 
                                           class="btn btn--small btn--success">
                                            <svg class="btn__icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            JSON
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Vista Mobile: Cards -->
                <div class="history-cards">
                    {% for job in jobs %}
                    <article class="history-card">
                        <div class="history-card__header">
                            <div class="history-card__channel">
                                <div class="channel-cell__avatar">
                                    {{ (job[1] or 'N')[0]|upper }}
                                </div>
                                <div class="history-card__info">
                                    <h4 class="history-card__name">{{ job[1] or 'N/A' }}</h4>
                                    <span class="history-card__date">{{ job[3] }}</span>
                                </div>
                            </div>
                            {% if job[2] == 'completed' %}
                                <span class="status-badge status-badge--success">
                                    <svg class="status-badge__icon" width="14" height="14" viewBox="0 0 24 24" fill="none">
                                        <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                                    </svg>
                                    Completado
                                </span>
                            {% elif job[2] == 'pending' %}
                                <span class="status-badge status-badge--pending">
                                    <svg class="status-badge__icon status-badge__icon--spinning" width="14" height="14" viewBox="0 0 24 24" fill="none">
                                        <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                    En proceso
                                </span>
                            {% else %}
                                <span class="status-badge status-badge--error">
                                    <svg class="status-badge__icon" width="14" height="14" viewBox="0 0 24 24" fill="none">
                                        <path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                    Error
                                </span>
                            {% endif %}
                        </div>
                        <div class="history-card__actions">
                            <a href="{{ url_for('show_result', job_id=job[0]) }}" 
                               class="btn btn--full {% if job[2] == 'pending' %}btn--gradient-soft{% else %}btn--gradient{% endif %}">
                                <svg class="btn__icon" width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke="currentColor" stroke-width="2"/>
                                    <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                {% if job[2] == 'pending' %}Ver Progreso{% else %}Ver Resultado{% endif %}
                            </a>
                            {% if job[2] == 'completed' %}
                            <a href="{{ url_for('download_json', job_id=job[0]) }}" 
                               class="btn btn--full btn--success">
                                <svg class="btn__icon" width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Descargar JSON
                            </a>
                            {% endif %}
                        </div>
                    </article>
                    {% endfor %}
                </div>
            {% else %}
                <!-- Estado vacío -->
                <div class="empty-state">
                    <svg class="empty-state__icon" width="64" height="64" viewBox="0 0 24 24" fill="none">
                        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 14h6M9 17h3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                    <h3 class="empty-state__title">Sin análisis previos</h3>
                    <p class="empty-state__description">
                        Aún no has realizado ningún análisis. Comienza analizando tu primer canal.
                    </p>
                    <a href="/" class="btn btn--primary btn--gradient">
                        <svg class="btn__icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Realizar primer análisis
                    </a>
                </div>
            {% endif %}
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer__container">
            <p class="footer__text">© 2024 Analizador de YouTube. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- JavaScript para funcionalidad -->
    <script>
        // Menú móvil hamburguesa
        const menuToggle = document.getElementById('menu-toggle');
        const mobileNav = document.getElementById('mobile-nav');
        
        if (menuToggle && mobileNav) {
            menuToggle.addEventListener('click', function() {
                const isOpen = mobileNav.classList.contains('active');
                mobileNav.classList.toggle('active');
                menuToggle.classList.toggle('active');
                menuToggle.setAttribute('aria-expanded', !isOpen);
            });
            
            // Cerrar menú al hacer click fuera
            document.addEventListener('click', function(event) {
                if (!menuToggle.contains(event.target) && !mobileNav.contains(event.target)) {
                    mobileNav.classList.remove('active');
                    menuToggle.classList.remove('active');
                    menuToggle.setAttribute('aria-expanded', 'false');
                }
            });
        }

        // Auto-refresh para análisis pendientes
        const pendingJobs = document.querySelectorAll('.status-badge--pending');
        if (pendingJobs.length > 0) {
            setTimeout(() => {
                window.location.reload();
            }, 5000); // Refresh cada 5 segundos si hay trabajos pendientes
        }
    </script>
</body>
</html>